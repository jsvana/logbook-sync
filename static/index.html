<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>logbook-sync</title>
    <style>
        :root {
            --bg: #1a1a2e;
            --surface: #16213e;
            --primary: #0f3460;
            --accent: #e94560;
            --text: #eee;
            --text-dim: #888;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .card {
            background: var(--surface);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        h1, h2, h3 { margin-bottom: 1rem; }
        input, select, button {
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--primary);
            border-radius: 4px;
            background: var(--bg);
            color: var(--text);
        }
        button {
            background: var(--accent);
            border: none;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; color: var(--text-dim); }
        .form-group input { width: 100%; }
        .tabs { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active { border-color: var(--accent); }
        .hidden { display: none !important; }
        .status { padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; }
        .status.success { background: #1a472a; }
        .status.error { background: #5c1a1a; }
        .integration-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--primary);
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        .toggle { display: flex; align-items: center; gap: 0.5rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--primary); }
        th { color: var(--text-dim); }
        .dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--primary);
            transition: background 0.2s;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: var(--primary); }
        .dropdown-item .desc { font-size: 0.85rem; color: var(--text-dim); margin-top: 0.25rem; }
        .integration-card.configured { border-color: var(--accent); }
        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        .badge.enabled { background: #1a472a; color: #4ade80; }
        .badge.disabled { background: #5c1a1a; color: #f87171; }
        #add-integration-menu {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background: var(--surface);
            border: 1px solid var(--primary);
            border-radius: 4px;
            min-width: 250px;
            z-index: 100;
            display: block;
        }
        #add-integration-menu.hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="login-view" class="card">
            <h1>logbook-sync</h1>
            <p style="color: var(--text-dim); margin-bottom: 1.5rem;">Amateur radio log synchronization</p>
            <div id="login-status" class="status hidden"></div>
            <form id="login-form">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" required autofocus>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" required>
                </div>
                <button type="submit">Login</button>
            </form>
        </div>

        <!-- Main App (hidden until logged in) -->
        <div id="app-view" class="hidden">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1>logbook-sync</h1>
                    <span id="user-callsign" style="color: var(--accent);"></span>
                </div>
                <button id="logout-btn">Logout</button>
            </header>

            <div class="tabs">
                <div class="tab active" data-tab="integrations">Integrations</div>
                <div class="tab" data-tab="qsos">QSOs</div>
                <div class="tab" data-tab="settings">Settings</div>
            </div>

            <!-- Integrations Tab -->
            <div id="tab-integrations" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="margin-bottom: 0;">Integrations</h2>
                        <div style="position: relative;">
                            <button id="add-integration-btn">+ Add Integration</button>
                            <div id="add-integration-menu" class="hidden">
                                <div id="add-integration-options"></div>
                            </div>
                        </div>
                    </div>
                    <div id="configured-integrations"></div>
                    <div id="no-integrations" class="hidden" style="color: var(--text-dim); text-align: center; padding: 2rem;">
                        No integrations configured yet. Click "Add Integration" to get started.
                    </div>
                </div>
            </div>

            <!-- QSOs Tab -->
            <div id="tab-qsos" class="tab-content hidden">
                <div class="card">
                    <h2>Upload Log</h2>
                    <p style="color: var(--text-dim); margin-bottom: 1rem;">Upload an ADIF file to import QSOs</p>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <input type="file" id="adif-file" accept=".adi,.adif" style="flex: 1;">
                        <button id="upload-btn">Upload</button>
                    </div>
                    <div id="upload-status" class="status hidden" style="margin-top: 1rem;"></div>
                </div>

                <div class="card">
                    <h2>QSO Statistics</h2>
                    <div id="qso-stats" style="margin-bottom: 1rem;"></div>
                </div>

                <div class="card">
                    <h2>Recent QSOs</h2>
                    <table id="qso-table">
                        <thead>
                            <tr><th>Date</th><th>Call</th><th>Band</th><th>Mode</th><th>Sync Status</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content hidden">
                <div class="card">
                    <h2>Profile Settings</h2>
                    <form id="profile-form">
                        <div class="form-group">
                            <label>Callsign</label>
                            <input type="text" name="callsign" id="settings-callsign">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="email" id="settings-email">
                        </div>
                        <button type="submit">Save Changes</button>
                    </form>
                </div>

                <div class="card">
                    <h2>Change Password</h2>
                    <form id="password-form">
                        <div class="form-group">
                            <label>Current Password</label>
                            <input type="password" name="current_password" required>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" name="new_password" required minlength="12">
                        </div>
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <input type="password" name="confirm_password" required>
                        </div>
                        <button type="submit">Change Password</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Integration Config Modal -->
        <div id="integration-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;">
            <div class="card" style="max-width: 500px; width: 100%;">
                <h2 id="modal-title"></h2>
                <form id="integration-form">
                    <div id="integration-fields"></div>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button type="submit">Save</button>
                        <button type="button" id="modal-cancel" style="background: var(--primary);">Cancel</button>
                        <button type="button" id="modal-test" style="background: var(--primary);">Test Connection</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // App state
        let currentUser = null;
        let integrations = [];

        // Integration type metadata
        const INTEGRATION_TYPES = {
            qrz: { name: 'QRZ.com', desc: 'Sync logbook with QRZ.com' },
            lofi: { name: 'Ham2K LoFi', desc: 'Sync with LoFi Portable Logger' },
            lotw: { name: 'LotW', desc: 'Logbook of The World' },
            clublog: { name: 'Club Log', desc: 'Upload to Club Log' },
            eqsl: { name: 'eQSL', desc: 'eQSL.cc electronic QSL' },
            hrdlog: { name: 'HRDLog', desc: 'HRDLog.net logbook' },
            wavelog: { name: 'Wavelog', desc: 'Self-hosted Wavelog instance' },
        };

        // Integration field definitions
        const INTEGRATION_FIELDS = {
            qrz: [
                { name: 'api_key', label: 'API Key', type: 'password', required: true },
                { name: 'upload_enabled', label: 'Enable Upload', type: 'checkbox', default: true },
                { name: 'download_enabled', label: 'Enable Download', type: 'checkbox', default: true },
            ],
            lofi: [
                { name: 'client_key', label: 'Client Key (UUID)', type: 'text', required: true },
                { name: 'client_secret', label: 'Client Secret', type: 'password', required: true },
            ],
            lotw: [
                { name: 'station_callsign', label: 'Station Callsign', type: 'text', required: true },
                { name: 'tqsl_path', label: 'TQSL Path', type: 'text' },
                { name: 'auto_upload', label: 'Auto Upload', type: 'checkbox', default: true },
            ],
            clublog: [
                { name: 'email', label: 'Email', type: 'email', required: true },
                { name: 'password', label: 'Password', type: 'password', required: true },
                { name: 'callsign', label: 'Callsign', type: 'text', required: true },
            ],
            eqsl: [
                { name: 'username', label: 'Username', type: 'text', required: true },
                { name: 'password', label: 'Password', type: 'password', required: true },
            ],
            hrdlog: [
                { name: 'callsign', label: 'Callsign', type: 'text', required: true },
                { name: 'upload_code', label: 'Upload Code', type: 'password', required: true },
            ],
            wavelog: [
                { name: 'base_url', label: 'Base URL', type: 'url', required: true },
                { name: 'api_key', label: 'API Key', type: 'password', required: true },
            ],
        };

        // API helpers
        async function api(path, options = {}) {
            const res = await fetch(`/api${path}`, {
                headers: { 'Content-Type': 'application/json', ...options.headers },
                ...options,
            });
            if (!res.ok && res.status === 401) {
                showLogin();
                throw new Error('Unauthorized');
            }
            return res.json();
        }

        // Auth
        async function checkAuth() {
            try {
                const user = await api('/auth/me');
                if (user) {
                    currentUser = user;
                    showApp();
                } else {
                    showLogin();
                }
            } catch {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('app-view').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('user-callsign').textContent = currentUser.callsign || currentUser.username;
            document.getElementById('settings-callsign').value = currentUser.callsign || '';
            document.getElementById('settings-email').value = currentUser.email || '';
            loadIntegrations();
            loadQsoStats();
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const status = document.getElementById('login-status');

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: form.username.value,
                        password: form.password.value,
                    }),
                });
                const data = await res.json();

                if (data.success) {
                    currentUser = data.user;
                    showApp();
                } else {
                    status.textContent = data.message || 'Login failed';
                    status.className = 'status error';
                    status.classList.remove('hidden');
                }
            } catch (err) {
                status.textContent = 'Connection error';
                status.className = 'status error';
                status.classList.remove('hidden');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await api('/auth/logout', { method: 'POST' });
            currentUser = null;
            showLogin();
        });

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                tab.classList.add('active');
                document.getElementById(`tab-${tab.dataset.tab}`).classList.remove('hidden');
            });
        });

        // Integrations
        async function loadIntegrations() {
            try {
                integrations = await api('/integrations');
                renderIntegrations();
            } catch (err) {
                console.error('Failed to load integrations:', err);
                integrations = [];
                renderIntegrations();
            }
        }

        function renderIntegrations() {
            const configuredContainer = document.getElementById('configured-integrations');
            const noIntegrationsMsg = document.getElementById('no-integrations');
            const dropdownOptions = document.getElementById('add-integration-options');

            const allTypes = Object.keys(INTEGRATION_TYPES);
            const configuredTypes = integrations.map(i => i.integration_type);
            const availableTypes = allTypes.filter(t => !configuredTypes.includes(t));

            // Render configured integrations
            if (integrations.length === 0) {
                configuredContainer.innerHTML = '';
                noIntegrationsMsg.classList.remove('hidden');
            } else {
                noIntegrationsMsg.classList.add('hidden');
                configuredContainer.innerHTML = integrations.map(integration => {
                    const type = integration.integration_type;
                    const meta = INTEGRATION_TYPES[type] || { name: type.toUpperCase(), desc: '' };
                    const enabled = integration.enabled;

                    return `
                        <div class="integration-card configured">
                            <div>
                                <strong>${meta.name}</strong>
                                <span class="badge ${enabled ? 'enabled' : 'disabled'}">${enabled ? 'Enabled' : 'Disabled'}</span>
                                <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">${meta.desc}</div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="configureIntegration('${type}')">Edit</button>
                                <button onclick="deleteIntegration('${type}')" style="background: var(--primary);">Remove</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Render dropdown options for available integrations
            if (availableTypes.length === 0) {
                dropdownOptions.innerHTML = '<div style="padding: 1rem; color: var(--text-dim); text-align: center;">All integrations configured</div>';
            } else {
                dropdownOptions.innerHTML = availableTypes.map(type => {
                    const meta = INTEGRATION_TYPES[type];
                    return `
                        <div class="dropdown-item" onclick="addIntegration('${type}')">
                            <strong>${meta.name}</strong>
                            <div class="desc">${meta.desc}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        function addIntegration(type) {
            document.getElementById('add-integration-menu').classList.add('hidden');
            configureIntegration(type);
        }

        async function deleteIntegration(type) {
            const meta = INTEGRATION_TYPES[type] || { name: type };
            if (!confirm(`Remove ${meta.name} integration?`)) return;

            try {
                await api(`/integrations/${type}`, { method: 'DELETE' });
                loadIntegrations();
            } catch (err) {
                alert('Failed to remove integration');
            }
        }

        // Add integration dropdown toggle
        document.getElementById('add-integration-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('add-integration-menu').classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('add-integration-menu');
            const btn = document.getElementById('add-integration-btn');
            if (!menu.contains(e.target) && e.target !== btn) {
                menu.classList.add('hidden');
            }
        });

        function configureIntegration(type) {
            const modal = document.getElementById('integration-modal');
            const fields = document.getElementById('integration-fields');
            const existing = integrations.find(i => i.integration_type === type);
            const meta = INTEGRATION_TYPES[type] || { name: type.toUpperCase() };

            document.getElementById('modal-title').textContent = `Configure ${meta.name}`;

            const fieldDefs = INTEGRATION_FIELDS[type] || [];
            fields.innerHTML = fieldDefs.map(field => {
                const value = existing?.config?.[field.name] ?? field.default ?? '';
                if (field.type === 'checkbox') {
                    return `
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="${field.name}" ${value ? 'checked' : ''}>
                                ${field.label}
                            </label>
                        </div>
                    `;
                }
                return `
                    <div class="form-group">
                        <label>${field.label}</label>
                        <input type="${field.type}" name="${field.name}" value="${field.type === 'password' ? '' : value}"
                               ${field.required ? 'required' : ''} placeholder="${field.type === 'password' && existing ? '(unchanged)' : ''}">
                    </div>
                `;
            }).join('') + `
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="enabled" ${existing?.enabled !== false ? 'checked' : ''}>
                        Enable this integration
                    </label>
                </div>
            `;

            modal.dataset.type = type;
            modal.classList.remove('hidden');
        }

        document.getElementById('modal-cancel').addEventListener('click', () => {
            document.getElementById('integration-modal').classList.add('hidden');
        });

        document.getElementById('integration-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const modal = document.getElementById('integration-modal');
            const type = modal.dataset.type;
            const form = e.target;
            const formData = new FormData(form);

            const fieldDefs = INTEGRATION_FIELDS[type] || [];
            const config = { type };
            fieldDefs.forEach(field => {
                if (field.type === 'checkbox') {
                    config[field.name] = formData.has(field.name);
                } else {
                    const value = formData.get(field.name);
                    if (value) config[field.name] = value;
                }
            });

            try {
                await api(`/integrations/${type}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        config: config,
                        enabled: formData.has('enabled'),
                    }),
                });
                modal.classList.add('hidden');
                loadIntegrations();
            } catch (err) {
                alert('Failed to save integration');
            }
        });

        document.getElementById('modal-test').addEventListener('click', async () => {
            const modal = document.getElementById('integration-modal');
            const type = modal.dataset.type;
            const form = document.getElementById('integration-form');
            const formData = new FormData(form);

            // Build config from current form values
            const fieldDefs = INTEGRATION_FIELDS[type] || [];
            const config = { type };
            fieldDefs.forEach(field => {
                if (field.type === 'checkbox') {
                    config[field.name] = formData.has(field.name);
                } else {
                    const value = formData.get(field.name);
                    if (value) config[field.name] = value;
                }
            });

            try {
                const result = await api(`/integrations/${type}/test`, {
                    method: 'POST',
                    body: JSON.stringify({ config }),
                });
                alert(result.success ? result.message : `Test failed: ${result.message}`);
            } catch {
                alert('Connection test failed');
            }
        });

        // File Upload
        document.getElementById('upload-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('adif-file');
            const status = document.getElementById('upload-status');

            if (!fileInput.files.length) {
                status.textContent = 'Please select a file';
                status.className = 'status error';
                status.classList.remove('hidden');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            status.textContent = 'Uploading...';
            status.className = 'status';
            status.classList.remove('hidden');

            try {
                const res = await fetch('/api/logs/upload', {
                    method: 'POST',
                    body: formData,
                });
                const result = await res.json();

                if (result.success) {
                    status.textContent = result.message || 'Upload successful!';
                    status.className = 'status success';
                    fileInput.value = '';
                    loadQsoStats();
                } else {
                    status.textContent = result.message || 'Upload failed';
                    status.className = 'status error';
                }
            } catch (err) {
                status.textContent = 'Upload failed: ' + err.message;
                status.className = 'status error';
            }
        });

        // QSO Stats
        async function loadQsoStats() {
            try {
                const stats = await api('/qsos/stats');
                document.getElementById('qso-stats').innerHTML = `
                    <p>Total QSOs: ${stats.total_qsos || 0}</p>
                    <p>Synced to QRZ: ${stats.synced_qrz || 0}</p>
                    <p>LotW Confirmed: ${stats.lotw_confirmed || 0}</p>
                `;
            } catch (err) {
                console.error('Failed to load QSO stats:', err);
            }
        }

        // Profile form
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            try {
                await api('/users/me', {
                    method: 'PUT',
                    body: JSON.stringify({
                        callsign: form.callsign.value || null,
                        email: form.email.value || null,
                    }),
                });
                alert('Profile updated');
                checkAuth();
            } catch {
                alert('Failed to update profile');
            }
        });

        // Password form
        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;

            if (form.new_password.value !== form.confirm_password.value) {
                alert('Passwords do not match');
                return;
            }

            try {
                const result = await api('/users/me/password', {
                    method: 'PUT',
                    body: JSON.stringify({
                        current_password: form.current_password.value,
                        new_password: form.new_password.value,
                    }),
                });
                if (result.success) {
                    alert('Password changed successfully');
                    form.reset();
                } else {
                    alert(result.message || 'Failed to change password');
                }
            } catch {
                alert('Failed to change password');
            }
        });

        // Init
        // Populate dropdown options immediately (before login)
        function populateIntegrationDropdown() {
            const dropdownOptions = document.getElementById('add-integration-options');
            const allTypes = Object.keys(INTEGRATION_TYPES);
            dropdownOptions.innerHTML = allTypes.map(type => {
                const meta = INTEGRATION_TYPES[type];
                return `
                    <div class="dropdown-item" onclick="addIntegration('${type}')">
                        <strong>${meta.name}</strong>
                        <div class="desc">${meta.desc}</div>
                    </div>
                `;
            }).join('');
        }
        populateIntegrationDropdown();
        checkAuth();
    </script>
</body>
</html>
