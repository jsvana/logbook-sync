<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>logbook-sync</title>
    <style>
        /* Light theme (default) */
        :root {
            --bg: #f5f5f7;
            --surface: #ffffff;
            --primary: #e0e0e0;
            --accent: #e94560;
            --text: #1a1a2e;
            --text-dim: #666;
            --success-bg: #d4edda;
            --error-bg: #f8d7da;
            --badge-enabled-bg: #d4edda;
            --badge-enabled-text: #155724;
            --badge-disabled-bg: #f8d7da;
            --badge-disabled-text: #721c24;
        }

        /* Dark theme */
        [data-theme="dark"] {
            --bg: #1a1a2e;
            --surface: #16213e;
            --primary: #0f3460;
            --accent: #e94560;
            --text: #eee;
            --text-dim: #888;
            --success-bg: #1a472a;
            --error-bg: #5c1a1a;
            --badge-enabled-bg: #1a472a;
            --badge-enabled-text: #4ade80;
            --badge-disabled-bg: #5c1a1a;
            --badge-disabled-text: #f87171;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .card {
            background: var(--surface);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        h1, h2, h3 { margin-bottom: 1rem; }
        input, select, button {
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--primary);
            border-radius: 4px;
            background: var(--bg);
            color: var(--text);
        }
        button {
            background: var(--accent);
            border: none;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; color: var(--text-dim); }
        .form-group input { width: 100%; }
        .tabs { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active { border-color: var(--accent); }
        .hidden { display: none !important; }
        .status { padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; }
        .status.success { background: var(--success-bg); }
        .status.error { background: var(--error-bg); }
        .integration-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--primary);
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        .toggle { display: flex; align-items: center; gap: 0.5rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--primary); }
        th { color: var(--text-dim); }
        .dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--primary);
            transition: background 0.2s;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: var(--primary); }
        .dropdown-item .desc { font-size: 0.85rem; color: var(--text-dim); margin-top: 0.25rem; }
        .integration-card.configured { border-color: var(--accent); }
        .integration-card-content { flex: 1; }
        .integration-card-actions { display: flex; gap: 0.5rem; align-items: flex-start; }
        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        .badge.enabled { background: var(--badge-enabled-bg); color: var(--badge-enabled-text); }
        .badge.disabled { background: var(--badge-disabled-bg); color: var(--badge-disabled-text); }
        .badge.under-construction { background: #fef3c7; color: #92400e; }
        [data-theme="dark"] .badge.under-construction { background: #78350f; color: #fcd34d; }
        .dropdown-item.under-construction { opacity: 0.6; cursor: not-allowed; }
        .dropdown-item.under-construction:hover { background: inherit; }
        .sync-status {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .sync-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--primary);
        }
        .sync-row:last-child { border-bottom: none; }
        .sync-direction {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .sync-direction-icon {
            font-size: 1rem;
            width: 1.5rem;
            text-align: center;
        }
        .sync-info {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }
        .sync-time {
            color: var(--text-dim);
            font-size: 0.8rem;
        }
        .sync-result {
            font-size: 0.75rem;
        }
        .sync-result.success { color: var(--badge-enabled-text); }
        .sync-result.error { color: var(--badge-disabled-text); }
        .sync-actions {
            display: flex;
            gap: 0.5rem;
        }
        .sync-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            background: var(--primary);
        }
        .sync-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .sync-btn.syncing {
            background: var(--text-dim);
        }
        .sync-interval-info {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-align: center;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--primary);
        }
        #add-integration-menu {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background: var(--surface);
            border: 1px solid var(--primary);
            border-radius: 4px;
            min-width: 250px;
            z-index: 100;
            display: block;
        }
        #add-integration-menu.hidden { display: none !important; }

        /* Loading spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            color: var(--text-dim);
        }
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--primary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.75rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Button spinner for inline loading states */
        .btn-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: var(--bg);
            border-radius: 4px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
        }
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 0.25rem;
        }
        /* POTA Modal Styles */
        .pota-activation {
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        .pota-activation.valid {
            background: var(--badge-enabled-bg);
            border: 1px solid var(--badge-enabled-text);
        }
        .pota-activation.invalid {
            background: var(--badge-disabled-bg);
            border: 1px solid var(--badge-disabled-text);
            color: var(--badge-disabled-text);
        }
        .pota-activation label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .pota-activation details {
            margin-top: 0.5rem;
        }
        .pota-activation summary {
            cursor: pointer;
            color: var(--text-dim);
            font-size: 0.85rem;
        }
        .pota-qso-table {
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
        .pota-qso-table th, .pota-qso-table td {
            padding: 0.25rem 0.5rem;
        }
        .no-activations {
            color: var(--text-dim);
            text-align: center;
            padding: 2rem;
        }
        .invalid-header {
            font-weight: bold;
            color: var(--badge-disabled-text);
            margin-bottom: 0.5rem;
        }
        .text-muted {
            color: var(--text-dim);
        }
        /* Job status colors */
        .status-success {
            background: var(--badge-enabled-bg);
            color: var(--badge-enabled-text);
        }
        .status-error {
            background: #3d2020;
            color: #ff6b6b;
        }
        .status-pending {
            background: #3d3520;
            color: #ffbb33;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="login-view" class="card">
            <h1>logbook-sync</h1>
            <p style="color: var(--text-dim); margin-bottom: 1.5rem;">Amateur radio log synchronization</p>
            <div id="login-status" class="status hidden"></div>
            <form id="login-form">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" required autofocus>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" required>
                </div>
                <button type="submit">Login</button>
            </form>
        </div>

        <!-- Main App (hidden until logged in) -->
        <div id="app-view" class="hidden">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1>logbook-sync</h1>
                    <span id="user-callsign" style="color: var(--accent);"></span>
                </div>
                <button id="logout-btn">Logout</button>
            </header>

            <div class="tabs">
                <div class="tab active" data-tab="integrations">Integrations</div>
                <div class="tab" data-tab="qsos">QSOs</div>
                <div class="tab" data-tab="settings">Settings</div>
            </div>

            <!-- Integrations Tab -->
            <div id="tab-integrations" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="margin-bottom: 0;">Integrations</h2>
                        <div style="position: relative;">
                            <button id="add-integration-btn">+ Add Integration</button>
                            <div id="add-integration-menu" class="hidden">
                                <div id="add-integration-options"></div>
                            </div>
                        </div>
                    </div>
                    <div id="integrations-loading" class="loading">
                        <div class="spinner"></div>
                        <span>Loading integrations...</span>
                    </div>
                    <div id="integrations-content" class="hidden">
                        <div id="configured-integrations"></div>
                        <div id="no-integrations" class="hidden" style="color: var(--text-dim); text-align: center; padding: 2rem;">
                            No integrations configured yet. Click "Add Integration" to get started.
                        </div>
                    </div>
                </div>
            </div>

            <!-- QSOs Tab -->
            <div id="tab-qsos" class="tab-content hidden">
                <div class="card">
                    <h2>QSO Log</h2>
                    <div id="qsos-loading" class="loading">
                        <div class="spinner"></div>
                        <span>Loading statistics...</span>
                    </div>
                    <div id="qsos-content" class="hidden">
                        <div id="qso-stats" class="stats-grid"></div>
                        <hr style="border: none; border-top: 1px solid var(--primary); margin: 1.5rem 0;">
                        <h3 style="margin-bottom: 0.75rem;">Upload ADIF Log</h3>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="file" id="adif-file" accept=".adi,.adif" style="flex: 1;">
                            <button id="upload-btn">Upload</button>
                        </div>
                        <div id="upload-status" class="status hidden" style="margin-top: 1rem;"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>Recent QSOs</h2>
                    <table id="qso-table">
                        <thead>
                            <tr><th>Date</th><th>Call</th><th>Band</th><th>Mode</th><th>Sync Status</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content hidden">
                <div class="card">
                    <h2>Profile Settings</h2>
                    <form id="profile-form">
                        <div class="form-group">
                            <label>Callsign</label>
                            <input type="text" name="callsign" id="settings-callsign">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="email" id="settings-email">
                        </div>
                        <button type="submit">Save Changes</button>
                    </form>
                </div>

                <div class="card">
                    <h2>Appearance</h2>
                    <div class="form-group">
                        <label>Theme</label>
                        <select id="theme-select" style="width: 200px;">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <h2>Change Password</h2>
                    <form id="password-form">
                        <div class="form-group">
                            <label>Current Password</label>
                            <input type="password" name="current_password" required>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" name="new_password" required minlength="12">
                        </div>
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <input type="password" name="confirm_password" required>
                        </div>
                        <button type="submit">Change Password</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Integration Config Modal -->
        <div id="integration-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;">
            <div class="card" style="max-width: 500px; width: 100%;">
                <h2 id="modal-title"></h2>
                <form id="integration-form">
                    <div id="integration-fields"></div>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button type="submit">Save</button>
                        <button type="button" id="modal-cancel" style="background: var(--primary);">Cancel</button>
                        <button type="button" id="modal-test" style="background: var(--primary);">Test Connection</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- LoFi Setup Modal -->
        <div id="lofi-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;">
            <div class="card" style="max-width: 500px; width: 100%;">
                <h2>Ham2K LoFi Setup</h2>

                <!-- Step 1: Setup -->
                <div id="lofi-step-setup">
                    <p style="color: var(--text-dim); margin-bottom: 1rem;">
                        Enter your callsign and email to connect with LoFi. A confirmation email will be sent.
                    </p>
                    <div class="form-group">
                        <label>Callsign</label>
                        <input type="text" id="lofi-callsign" required placeholder="e.g., W1ABC">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="lofi-email" required placeholder="Your email for confirmation">
                    </div>
                    <div id="lofi-setup-error" class="status error hidden" style="margin-bottom: 1rem;"></div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" id="lofi-setup-btn">Setup LoFi</button>
                        <button type="button" id="lofi-cancel-btn" style="background: var(--primary);">Cancel</button>
                    </div>
                </div>

                <!-- Step 2: Waiting for confirmation -->
                <div id="lofi-step-pending" class="hidden">
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">&#9993;</div>
                        <p style="margin-bottom: 1rem;">A confirmation email has been sent to:</p>
                        <p style="color: var(--accent); font-weight: bold; margin-bottom: 1.5rem;" id="lofi-pending-email"></p>
                        <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                            Click the link in the email from Ham2K, then click "I've Confirmed" below.
                        </p>
                    </div>
                    <div id="lofi-pending-error" class="status error hidden" style="margin-bottom: 1rem;"></div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button type="button" id="lofi-confirm-btn">I've Confirmed</button>
                        <button type="button" id="lofi-resend-btn" style="background: var(--primary);">Resend Email</button>
                        <button type="button" id="lofi-pending-cancel-btn" style="background: var(--primary);">Cancel</button>
                    </div>
                </div>

                <!-- Step 3: Active -->
                <div id="lofi-step-active" class="hidden">
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--badge-enabled-text);">&#10003;</div>
                        <p style="color: var(--badge-enabled-text); font-weight: bold; margin-bottom: 1rem;">LoFi Integration Active</p>
                        <p style="color: var(--text-dim); margin-bottom: 1rem;">
                            Your logbook is syncing with Ham2K LoFi.
                        </p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" id="lofi-done-btn">Done</button>
                        <button type="button" id="lofi-remove-btn" style="background: var(--primary);">Remove Integration</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- POTA Preview/Upload Modal -->
        <div id="pota-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div class="card" style="max-width: 700px; width: 100%; max-height: 80vh; overflow-y: auto; position: relative;">
                <button type="button" onclick="closePotaModal()" style="position: absolute; top: 0.75rem; right: 0.75rem; background: transparent; border: none; color: var(--text-dim); font-size: 1.5rem; cursor: pointer; padding: 0.25rem 0.5rem; line-height: 1;" title="Close">&times;</button>
                <h2>POTA Activation Upload</h2>
                <div id="pota-summary" style="margin-bottom: 1rem; padding: 0.75rem; background: var(--surface); border-radius: 4px;"></div>
                <div id="pota-selection-controls" style="margin-bottom: 0.5rem; display: none;">
                    <button type="button" id="pota-toggle-all" onclick="toggleAllPotaActivations()" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Deselect All</button>
                </div>
                <div id="pota-valid-activations" style="margin-bottom: 1rem;"></div>
                <div id="pota-invalid-activations" style="margin-bottom: 1rem;"></div>
                <div id="pota-jobs-section" style="margin-bottom: 1rem; display: none;">
                    <h3 style="margin-bottom: 0.5rem;">Recent Upload Jobs</h3>
                    <div id="pota-jobs-list"></div>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button type="button" id="pota-upload-btn" onclick="uploadSelectedPota()">Upload Selected</button>
                    <button type="button" id="pota-check-status-btn" onclick="checkPotaJobStatus()" style="background: var(--primary);">Check Upload Status</button>
                    <button type="button" onclick="closePotaModal()" style="background: var(--primary);">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App state
        let currentUser = null;
        let integrations = [];

        // Integration type metadata
        const INTEGRATION_TYPES = {
            qrz: { name: 'QRZ.com', desc: 'Sync logbook with QRZ.com' },
            lofi: { name: 'Ham2K LoFi', desc: 'Sync with LoFi Portable Logger' },
            lotw: { name: 'LotW', desc: 'Logbook of The World', underConstruction: true },
            clublog: { name: 'Club Log', desc: 'Upload to Club Log', underConstruction: true },
            eqsl: { name: 'eQSL', desc: 'eQSL.cc electronic QSL', underConstruction: true },
            hrdlog: { name: 'HRDLog', desc: 'HRDLog.net logbook', underConstruction: true },
            wavelog: { name: 'Wavelog', desc: 'Self-hosted Wavelog instance', underConstruction: true },
            ntfy: { name: 'ntfy', desc: 'Push notifications via ntfy.sh' },
            pota: { name: 'POTA.app', desc: 'Parks on the Air activation upload', underConstruction: true },
        };

        // Integration field definitions (lofi has its own wizard)
        const INTEGRATION_FIELDS = {
            qrz: [
                { name: 'api_key', label: 'API Key', type: 'password', required: true },
                { name: 'upload_enabled', label: 'Enable Upload', type: 'checkbox', default: true },
                { name: 'download_enabled', label: 'Enable Download', type: 'checkbox', default: true },
            ],
            lotw: [
                { name: 'station_callsign', label: 'Station Callsign', type: 'text', required: true },
                { name: 'tqsl_path', label: 'TQSL Path', type: 'text' },
                { name: 'auto_upload', label: 'Auto Upload', type: 'checkbox', default: true },
            ],
            clublog: [
                { name: 'email', label: 'Email', type: 'email', required: true },
                { name: 'password', label: 'Password', type: 'password', required: true },
                { name: 'callsign', label: 'Callsign', type: 'text', required: true },
            ],
            eqsl: [
                { name: 'username', label: 'Username', type: 'text', required: true },
                { name: 'password', label: 'Password', type: 'password', required: true },
            ],
            hrdlog: [
                { name: 'callsign', label: 'Callsign', type: 'text', required: true },
                { name: 'upload_code', label: 'Upload Code', type: 'password', required: true },
            ],
            wavelog: [
                { name: 'base_url', label: 'Base URL', type: 'url', required: true },
                { name: 'api_key', label: 'API Key', type: 'password', required: true },
            ],
            ntfy: [
                { name: 'server', label: 'Server URL', type: 'url', default: 'https://ntfy.sh' },
                { name: 'topic', label: 'Topic', type: 'text', required: true },
                { name: 'token', label: 'Access Token (optional)', type: 'password' },
                { name: 'priority', label: 'Priority (1-5)', type: 'number', default: 3 },
                { name: 'notify_on_sync', label: 'Notify on Sync', type: 'checkbox', default: true },
                { name: 'notify_on_error', label: 'Notify on Error', type: 'checkbox', default: true },
            ],
            pota: [
                { name: 'email', label: 'POTA.app Email', type: 'email', required: true },
                { name: 'password', label: 'POTA.app Password', type: 'password', required: true },
            ],
        };

        // API helpers
        async function api(path, options = {}) {
            const res = await fetch(`/api${path}`, {
                headers: { 'Content-Type': 'application/json', ...options.headers },
                ...options,
            });
            if (!res.ok && res.status === 401) {
                showLogin();
                throw new Error('Unauthorized');
            }
            return res.json();
        }

        // Auth
        async function checkAuth() {
            try {
                const user = await api('/auth/me');
                if (user) {
                    currentUser = user;
                    showApp();
                } else {
                    showLogin();
                }
            } catch {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('app-view').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('user-callsign').textContent = currentUser.callsign || currentUser.username;
            document.getElementById('settings-callsign').value = currentUser.callsign || '';
            document.getElementById('settings-email').value = currentUser.email || '';
            // Apply user's theme preference
            applyTheme(currentUser.theme || 'light');
            document.getElementById('theme-select').value = currentUser.theme || 'light';
            loadIntegrations();
            loadQsoStats();
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const status = document.getElementById('login-status');

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: form.username.value,
                        password: form.password.value,
                    }),
                });
                const data = await res.json();

                if (data.success) {
                    currentUser = data.user;
                    showApp();
                } else {
                    status.textContent = data.message || 'Login failed';
                    status.className = 'status error';
                    status.classList.remove('hidden');
                }
            } catch (err) {
                status.textContent = 'Connection error';
                status.className = 'status error';
                status.classList.remove('hidden');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await api('/auth/logout', { method: 'POST' });
            currentUser = null;
            showLogin();
        });

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                tab.classList.add('active');
                document.getElementById(`tab-${tab.dataset.tab}`).classList.remove('hidden');
            });
        });

        // Integrations
        async function loadIntegrations() {
            const loadingEl = document.getElementById('integrations-loading');
            const contentEl = document.getElementById('integrations-content');

            loadingEl.classList.remove('hidden');
            contentEl.classList.add('hidden');

            try {
                integrations = await api('/integrations');
                renderIntegrations();
            } catch (err) {
                console.error('Failed to load integrations:', err);
                integrations = [];
                renderIntegrations();
            } finally {
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
            }
        }

        // Sync capabilities per integration type
        const SYNC_CAPABILITIES = {
            qrz: { upload: true, download: true },
            lofi: { upload: false, download: true },
            lotw: { upload: true, download: true },
            clublog: { upload: true, download: false },
            eqsl: { upload: true, download: true },
            hrdlog: { upload: true, download: false },
            wavelog: { upload: true, download: true },
            ntfy: { upload: false, download: false }, // Notifications only, no sync
            pota: { upload: false, download: false, manualUpload: true }, // Manual upload with preview
        };

        function formatSyncTime(isoString) {
            if (!isoString) return 'Never';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        function formatNextSyncTime(lastSyncIso, intervalSecs) {
            if (!lastSyncIso || !intervalSecs) return null;
            const lastSync = new Date(lastSyncIso);
            const nextSync = new Date(lastSync.getTime() + intervalSecs * 1000);
            const now = new Date();
            const diffMs = nextSync - now;

            if (diffMs <= 0) return 'Now';

            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);

            if (diffMins < 1) return '< 1m';
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h ${diffMins % 60}m`;
            return `${Math.floor(diffHours / 24)}d`;
        }

        function formatIntervalSecs(secs) {
            if (!secs) return '';
            if (secs < 60) return `${secs}s`;
            if (secs < 3600) return `${Math.floor(secs / 60)}m`;
            return `${Math.floor(secs / 3600)}h`;
        }

        function renderSyncStatus(type, syncState, config, syncIntervalSecs, stats) {
            const caps = SYNC_CAPABILITIES[type] || {};
            const rows = [];

            // Special case for LoFi - show synced counts
            if (type === 'lofi') {
                const dlState = syncState?.download;
                const lastSync = dlState?.last_sync_at;
                const result = dlState?.last_sync_result;
                const resultClass = result === 'success' ? 'success' : (result === 'error' ? 'error' : '');
                const nextSync = formatNextSyncTime(lastSync, syncIntervalSecs);
                const intervalStr = formatIntervalSecs(syncIntervalSecs);

                const operations = stats?.operations || 0;
                const qsos = stats?.qsos || 0;
                const potaOps = stats?.pota_operations || 0;

                return `<div class="sync-status">
                    <div class="sync-row">
                        <div class="sync-direction">
                            <span class="sync-direction-icon">&#8595;</span>
                            <div class="sync-info">
                                <span>Synced from Ham2K PoLo</span>
                                <span class="sync-time">Last: ${formatSyncTime(lastSync)}${nextSync ? ` · Next: ${nextSync}` : ''}</span>
                                <span class="sync-result ${resultClass}">${operations} operations · ${qsos} QSOs${potaOps > 0 ? ` · ${potaOps} POTA` : ''}</span>
                            </div>
                        </div>
                        <div class="sync-actions">
                            <button class="sync-btn" onclick="forceSync('lofi', 'download')" id="sync-lofi-download">
                                Sync Now
                            </button>
                        </div>
                    </div>
                    <div class="sync-interval-info">Auto-sync every ${intervalStr}</div>
                </div>`;
            }

            // Special case for ntfy - show test button instead of sync status
            if (type === 'ntfy') {
                return `<div class="sync-status">
                    <div class="sync-row">
                        <div class="sync-direction">
                            <div class="sync-info">
                                <span>Push Notifications</span>
                                <span class="sync-time">Send a test notification to verify setup</span>
                            </div>
                        </div>
                        <div class="sync-actions">
                            <button class="sync-btn" onclick="testNtfy()" id="test-ntfy-btn">
                                Test
                            </button>
                        </div>
                    </div>
                </div>`;
            }

            // Special case for POTA - manual upload with preview
            if (type === 'pota') {
                const ulState = syncState?.upload;
                const lastSync = ulState?.last_sync_at;
                const result = ulState?.last_sync_result;
                const resultClass = result === 'success' ? 'success' : (result === 'error' ? 'error' : '');
                const message = ulState?.last_sync_message || '';

                return `<div class="sync-status">
                    <div class="sync-row">
                        <div class="sync-direction">
                            <span class="sync-direction-icon">&#8593;</span>
                            <div class="sync-info">
                                <span>Activation Upload</span>
                                <span class="sync-time">Last: ${formatSyncTime(lastSync)}</span>
                                ${result ? `<span class="sync-result ${resultClass}">${message}</span>` : ''}
                            </div>
                        </div>
                        <div class="sync-actions">
                            <button class="sync-btn" onclick="showPotaPreview()" id="pota-preview-btn">
                                Preview
                            </button>
                        </div>
                    </div>
                    <div class="sync-interval-info">Manual upload only (preview shows valid activations)</div>
                </div>`;
            }

            // Check if upload/download is enabled in config
            const uploadEnabled = config?.upload_enabled !== false && caps.upload;
            const downloadEnabled = config?.download_enabled !== false && caps.download;

            if (caps.download && downloadEnabled) {
                const dlState = syncState?.download;
                const lastSync = dlState?.last_sync_at;
                const result = dlState?.last_sync_result;
                const resultClass = result === 'success' ? 'success' : (result === 'error' ? 'error' : '');
                const itemsSynced = dlState?.items_synced || 0;
                const nextSync = formatNextSyncTime(lastSync, syncIntervalSecs);

                rows.push(`
                    <div class="sync-row">
                        <div class="sync-direction">
                            <span class="sync-direction-icon">&#8595;</span>
                            <div class="sync-info">
                                <span>Download</span>
                                <span class="sync-time">Last: ${formatSyncTime(lastSync)}${nextSync ? ` · Next: ${nextSync}` : ''}</span>
                                ${result ? `<span class="sync-result ${resultClass}">${itemsSynced} items</span>` : ''}
                            </div>
                        </div>
                        <div class="sync-actions">
                            <button class="sync-btn" onclick="forceSync('${type}', 'download')" id="sync-${type}-download">
                                Sync Now
                            </button>
                        </div>
                    </div>
                `);
            }

            if (caps.upload && uploadEnabled) {
                const ulState = syncState?.upload;
                const lastSync = ulState?.last_sync_at;
                const result = ulState?.last_sync_result;
                const resultClass = result === 'success' ? 'success' : (result === 'error' ? 'error' : '');
                const itemsSynced = ulState?.items_synced || 0;
                const nextSync = formatNextSyncTime(lastSync, syncIntervalSecs);

                rows.push(`
                    <div class="sync-row">
                        <div class="sync-direction">
                            <span class="sync-direction-icon">&#8593;</span>
                            <div class="sync-info">
                                <span>Upload</span>
                                <span class="sync-time">Last: ${formatSyncTime(lastSync)}${nextSync ? ` · Next: ${nextSync}` : ''}</span>
                                ${result ? `<span class="sync-result ${resultClass}">${itemsSynced} items</span>` : ''}
                            </div>
                        </div>
                        <div class="sync-actions">
                            <button class="sync-btn" onclick="forceSync('${type}', 'upload')" id="sync-${type}-upload">
                                Sync Now
                            </button>
                        </div>
                    </div>
                `);
            }

            if (rows.length === 0) return '';

            // Add sync interval info at the bottom
            const intervalStr = formatIntervalSecs(syncIntervalSecs);
            return `<div class="sync-status">
                ${rows.join('')}
                <div class="sync-interval-info">Auto-sync every ${intervalStr}</div>
            </div>`;
        }

        function renderIntegrations() {
            const configuredContainer = document.getElementById('configured-integrations');
            const noIntegrationsMsg = document.getElementById('no-integrations');
            const dropdownOptions = document.getElementById('add-integration-options');

            const allTypes = Object.keys(INTEGRATION_TYPES);
            const configuredTypes = integrations.map(i => i.integration_type);
            const availableTypes = allTypes.filter(t => !configuredTypes.includes(t));

            // Render configured integrations
            if (integrations.length === 0) {
                configuredContainer.innerHTML = '';
                noIntegrationsMsg.classList.remove('hidden');
            } else {
                noIntegrationsMsg.classList.add('hidden');
                configuredContainer.innerHTML = integrations.map(integration => {
                    const type = integration.integration_type;
                    const meta = INTEGRATION_TYPES[type] || { name: type.toUpperCase(), desc: '' };
                    const enabled = integration.enabled;
                    const syncStatusHtml = enabled ? renderSyncStatus(type, integration.sync_state, integration.config, integration.sync_interval_secs, integration.stats) : '';

                    return `
                        <div class="integration-card configured">
                            <div class="integration-card-content">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div>
                                        <strong>${meta.name}</strong>
                                        <span class="badge ${enabled ? 'enabled' : 'disabled'}">${enabled ? 'Enabled' : 'Disabled'}</span>
                                        <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">${meta.desc}</div>
                                    </div>
                                    <div class="integration-card-actions">
                                        <button onclick="configureIntegration('${type}')">Edit</button>
                                        <button onclick="deleteIntegration('${type}')" style="background: var(--primary);">Remove</button>
                                    </div>
                                </div>
                                ${syncStatusHtml}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Render dropdown options for available integrations
            // Separate available types into ready and under-construction
            const readyTypes = availableTypes.filter(t => !INTEGRATION_TYPES[t].underConstruction);
            const constructionTypes = availableTypes.filter(t => INTEGRATION_TYPES[t].underConstruction);

            if (readyTypes.length === 0 && constructionTypes.length === 0) {
                dropdownOptions.innerHTML = '<div style="padding: 1rem; color: var(--text-dim); text-align: center;">All integrations configured</div>';
            } else {
                let html = '';
                // Ready integrations (clickable)
                html += readyTypes.map(type => {
                    const meta = INTEGRATION_TYPES[type];
                    return `
                        <div class="dropdown-item" onclick="addIntegration('${type}')">
                            <strong>${meta.name}</strong>
                            <div class="desc">${meta.desc}</div>
                        </div>
                    `;
                }).join('');
                // Under construction integrations (not clickable)
                if (constructionTypes.length > 0) {
                    html += '<div style="padding: 0.5rem 1rem; color: var(--text-dim); font-size: 0.8rem; border-top: 1px solid var(--primary); margin-top: 0.5rem;">Coming Soon</div>';
                    html += constructionTypes.map(type => {
                        const meta = INTEGRATION_TYPES[type];
                        return `
                            <div class="dropdown-item under-construction">
                                <strong>${meta.name}</strong> <span class="badge under-construction">Under Construction</span>
                                <div class="desc">${meta.desc}</div>
                            </div>
                        `;
                    }).join('');
                }
                dropdownOptions.innerHTML = html;
            }
        }

        function addIntegration(type) {
            document.getElementById('add-integration-menu').classList.add('hidden');
            // Block under-construction integrations
            const meta = INTEGRATION_TYPES[type];
            if (meta && meta.underConstruction) {
                alert(`${meta.name} is under construction and not yet available.`);
                return;
            }
            if (type === 'lofi') {
                openLofiModal();
            } else {
                configureIntegration(type);
            }
        }

        async function deleteIntegration(type) {
            const meta = INTEGRATION_TYPES[type] || { name: type };
            if (!confirm(`Remove ${meta.name} integration?`)) return;

            try {
                await api(`/integrations/${type}`, { method: 'DELETE' });
                loadIntegrations();
            } catch (err) {
                alert('Failed to remove integration');
            }
        }

        // Test ntfy notification
        async function testNtfy() {
            const btn = document.getElementById('test-ntfy-btn');
            if (!btn) return;

            // Get ntfy config from current integrations
            const ntfyIntegration = integrations.find(i => i.integration_type === 'ntfy');
            if (!ntfyIntegration || !ntfyIntegration.config) {
                alert('ntfy integration not configured');
                return;
            }

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Sending...';
            btn.classList.add('syncing');

            try {
                const result = await api('/integrations/ntfy/test', {
                    method: 'POST',
                    body: JSON.stringify({ config: ntfyIntegration.config }),
                });

                if (result.success) {
                    alert('Test notification sent! Check your ntfy app.');
                } else {
                    alert(`Test failed: ${result.message}`);
                }
            } catch (err) {
                alert(`Test error: ${err.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
                btn.classList.remove('syncing');
            }
        }

        // POTA preview/upload functions
        let potaPreviewData = null;

        async function showPotaPreview() {
            const btn = document.getElementById('pota-preview-btn');
            if (!btn) return;

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Loading...';
            btn.classList.add('syncing');

            try {
                const result = await api('/sync/pota/preview');
                if (!result.success) {
                    alert(`Preview failed: ${result.message}`);
                    return;
                }

                potaPreviewData = result;
                renderPotaModal(result);
                document.getElementById('pota-modal').classList.remove('hidden');
            } catch (err) {
                alert(`Preview error: ${err.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
                btn.classList.remove('syncing');
            }
        }

        function renderPotaModal(data) {
            const validList = document.getElementById('pota-valid-activations');
            const invalidList = document.getElementById('pota-invalid-activations');
            const summary = document.getElementById('pota-summary');

            const totalActivations = data.valid_activations.length + data.invalid_activations.length;

            // Summary
            summary.innerHTML = `
                <strong>${totalActivations}</strong> activation${totalActivations !== 1 ? 's' : ''}
                (<strong>${data.total_qsos}</strong> QSOs) found.
                ${data.valid_activations.length > 0 ? `<br><span class="text-success">${data.valid_activations.length} complete (10+ QSOs)</span>` : ''}
                ${data.invalid_activations.length > 0 ? `<br><span class="text-muted">${data.invalid_activations.length} incomplete (&lt;10 QSOs - can still upload)</span>` : ''}
                ${data.skipped_qsos > 0 ? `<br><span class="text-muted">${data.skipped_qsos} non-POTA QSOs skipped</span>` : ''}
            `;

            // Valid activations
            const selectionControls = document.getElementById('pota-selection-controls');
            if (data.valid_activations.length > 0 || data.invalid_activations.length > 0) {
                selectionControls.style.display = 'block';
            } else {
                selectionControls.style.display = 'none';
            }

            if (data.valid_activations.length > 0) {
                validList.innerHTML = `
                    <div class="section-header">Complete Activations (10+ QSOs)</div>
                    ${data.valid_activations.map(a => `
                    <div class="pota-activation valid">
                        <label>
                            <input type="checkbox" checked value="${a.park_ref}:${a.date}" class="pota-activation-checkbox" onchange="updatePotaUploadButton(); updatePotaToggleButton();">
                            <strong>${a.park_ref}</strong> on ${formatPotaDate(a.date)} - ${a.qso_count} QSOs
                        </label>
                        <details>
                            <summary>View QSOs</summary>
                            <table class="pota-qso-table">
                                <thead><tr><th>Call</th><th>Time</th><th>Band</th><th>Mode</th></tr></thead>
                                <tbody>
                                    ${a.qsos.map(q => `<tr><td>${q.call}</td><td>${formatPotaTime(q.time)}</td><td>${q.band}</td><td>${q.mode}</td></tr>`).join('')}
                                </tbody>
                            </table>
                        </details>
                    </div>
                `).join('')}`;
                updatePotaToggleButton();
            } else {
                validList.innerHTML = '';
            }

            // Incomplete activations (now with checkboxes!)
            if (data.invalid_activations.length > 0) {
                invalidList.innerHTML = `
                    <div class="section-header">Incomplete Activations (&lt;10 QSOs)</div>
                    ${data.invalid_activations.map(a => `
                        <div class="pota-activation invalid">
                            <label>
                                <input type="checkbox" value="${a.park_ref}:${a.date}" class="pota-activation-checkbox" onchange="updatePotaUploadButton(); updatePotaToggleButton();">
                                <strong>${a.park_ref}</strong> on ${formatPotaDate(a.date)} - ${a.qso_count} QSOs <span class="text-muted">(need ${10 - a.qso_count} more for credit)</span>
                            </label>
                            <details>
                                <summary>View QSOs</summary>
                                <table class="pota-qso-table">
                                    <thead><tr><th>Call</th><th>Time</th><th>Band</th><th>Mode</th></tr></thead>
                                    <tbody>
                                        ${a.qsos.map(q => `<tr><td>${q.call}</td><td>${formatPotaTime(q.time)}</td><td>${q.band}</td><td>${q.mode}</td></tr>`).join('')}
                                    </tbody>
                                </table>
                            </details>
                        </div>
                    `).join('')}
                `;
            } else {
                invalidList.innerHTML = '';
            }

            // Show message if no activations at all
            if (data.valid_activations.length === 0 && data.invalid_activations.length === 0) {
                validList.innerHTML = '<div class="no-activations">No POTA activations found (QSOs need MY_SIG=POTA and MY_SIG_INFO with park reference)</div>';
            }

            // Update upload button state
            updatePotaUploadButton();
        }

        function formatPotaDate(dateStr) {
            if (dateStr.length === 8) {
                return `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}`;
            }
            return dateStr;
        }

        function formatPotaTime(timeStr) {
            if (timeStr.length >= 4) {
                return `${timeStr.slice(0,2)}:${timeStr.slice(2,4)}`;
            }
            return timeStr;
        }

        function updatePotaUploadButton() {
            const btn = document.getElementById('pota-upload-btn');
            const checkboxes = document.querySelectorAll('.pota-activation-checkbox:checked');
            btn.disabled = checkboxes.length === 0;
            btn.textContent = checkboxes.length > 0 ? `Upload ${checkboxes.length} Activation${checkboxes.length > 1 ? 's' : ''}` : 'Select activations to upload';
        }

        function closePotaModal() {
            document.getElementById('pota-modal').classList.add('hidden');
            document.getElementById('pota-jobs-section').style.display = 'none';
            potaPreviewData = null;
        }

        async function checkPotaJobStatus() {
            const btn = document.getElementById('pota-check-status-btn');
            const jobsSection = document.getElementById('pota-jobs-section');
            const jobsList = document.getElementById('pota-jobs-list');

            // Show loading state
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="btn-spinner"></span>Loading...';
            btn.disabled = true;

            try {
                const result = await api('/sync/pota/jobs');
                if (result.success) {
                    if (result.jobs.length === 0) {
                        jobsList.innerHTML = '<div class="text-muted">No upload jobs found</div>';
                    } else {
                        jobsList.innerHTML = result.jobs.slice(0, 10).map(job => {
                            const statusClass = job.status === 'Completed' ? 'status-success' :
                                               job.status === 'Failed' ? 'status-error' :
                                               'status-pending';
                            return `
                                <div class="pota-job" style="padding: 0.5rem; margin-bottom: 0.5rem; background: var(--surface); border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <strong>${job.park_ref}</strong>
                                        <span class="${statusClass}" style="padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">${job.status}</span>
                                    </div>
                                    <div style="font-size: 0.875rem; color: var(--text-dim);">
                                        ${job.park_name || ''} ${job.callsign ? '(' + job.callsign + ')' : ''}
                                    </div>
                                    <div style="font-size: 0.875rem;">
                                        ${job.inserted_qsos}/${job.total_qsos} QSOs inserted
                                        ${job.processed ? ' • Processed: ' + job.processed : ' • Submitted: ' + job.submitted}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                    jobsSection.style.display = 'block';
                } else {
                    alert(`Failed to get job status: ${result.message}`);
                }
            } catch (err) {
                alert(`Error: ${err.message}`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function toggleAllPotaActivations() {
            const checkboxes = document.querySelectorAll('.pota-activation-checkbox');
            const checkedCount = document.querySelectorAll('.pota-activation-checkbox:checked').length;
            const allChecked = checkedCount === checkboxes.length;

            // If all are checked, uncheck all. Otherwise, check all.
            checkboxes.forEach(cb => cb.checked = !allChecked);

            updatePotaUploadButton();
            updatePotaToggleButton();
        }

        function updatePotaToggleButton() {
            const btn = document.getElementById('pota-toggle-all');
            const checkboxes = document.querySelectorAll('.pota-activation-checkbox');
            const checkedCount = document.querySelectorAll('.pota-activation-checkbox:checked').length;

            if (checkedCount === checkboxes.length) {
                btn.textContent = 'Deselect All';
            } else {
                btn.textContent = 'Select All';
            }
        }

        async function uploadSelectedPota() {
            const checkboxes = document.querySelectorAll('.pota-activation-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one activation to upload');
                return;
            }

            const activations = Array.from(checkboxes).map(cb => cb.value);
            const btn = document.getElementById('pota-upload-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Uploading...';

            try {
                const result = await api('/sync/pota/upload', {
                    method: 'POST',
                    body: JSON.stringify({ activations }),
                });

                if (result.success) {
                    alert(`Successfully uploaded ${result.activations_uploaded} activation(s) (${result.qsos_uploaded} QSOs)`);
                    closePotaModal();
                    loadIntegrations(); // Refresh to show updated sync status
                } else {
                    let msg = result.message;
                    if (result.errors && result.errors.length > 0) {
                        msg += '\n\nErrors:\n' + result.errors.join('\n');
                    }
                    alert(msg);
                }
            } catch (err) {
                alert(`Upload error: ${err.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
                updatePotaUploadButton();
            }
        }

        // Force sync function
        async function forceSync(type, direction) {
            const btn = document.getElementById(`sync-${type}-${direction}`);
            if (!btn) return;

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Syncing...';
            btn.classList.add('syncing');

            try {
                let endpoint;
                if (type === 'lofi') {
                    endpoint = '/sync/lofi';
                } else if (type === 'qrz') {
                    endpoint = direction === 'upload' ? '/sync/qrz/upload' : '/sync/qrz/download';
                } else {
                    // Future integrations
                    endpoint = `/sync/${type}/${direction}`;
                }

                const result = await api(endpoint, { method: 'POST' });

                if (result.success) {
                    // Refresh integrations to show updated sync state
                    await loadIntegrations();
                } else {
                    alert(`Sync failed: ${result.message}`);
                    btn.disabled = false;
                    btn.textContent = originalText;
                    btn.classList.remove('syncing');
                }
            } catch (err) {
                alert(`Sync error: ${err.message}`);
                btn.disabled = false;
                btn.textContent = originalText;
                btn.classList.remove('syncing');
            }
        }

        // Add integration dropdown toggle
        document.getElementById('add-integration-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('add-integration-menu').classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('add-integration-menu');
            const btn = document.getElementById('add-integration-btn');
            if (!menu.contains(e.target) && e.target !== btn) {
                menu.classList.add('hidden');
            }
        });

        function configureIntegration(type) {
            // LoFi has its own modal
            if (type === 'lofi') {
                openLofiModal();
                return;
            }

            const meta = INTEGRATION_TYPES[type] || { name: type.toUpperCase() };

            // Block under-construction integrations
            if (meta.underConstruction) {
                alert(`${meta.name} is under construction and not yet available.`);
                return;
            }

            const modal = document.getElementById('integration-modal');
            const fields = document.getElementById('integration-fields');
            const existing = integrations.find(i => i.integration_type === type);

            document.getElementById('modal-title').textContent = `Configure ${meta.name}`;

            const fieldDefs = INTEGRATION_FIELDS[type] || [];
            fields.innerHTML = fieldDefs.map(field => {
                const value = existing?.config?.[field.name] ?? field.default ?? '';
                if (field.type === 'checkbox') {
                    return `
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="${field.name}" ${value ? 'checked' : ''}>
                                ${field.label}
                            </label>
                        </div>
                    `;
                }
                return `
                    <div class="form-group">
                        <label>${field.label}</label>
                        <input type="${field.type}" name="${field.name}" value="${field.type === 'password' ? '' : value}"
                               ${field.required ? 'required' : ''} placeholder="${field.type === 'password' && existing ? '(unchanged)' : ''}">
                    </div>
                `;
            }).join('') + `
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="enabled" ${existing?.enabled !== false ? 'checked' : ''}>
                        Enable this integration
                    </label>
                </div>
            `;

            modal.dataset.type = type;
            modal.classList.remove('hidden');
        }

        document.getElementById('modal-cancel').addEventListener('click', () => {
            document.getElementById('integration-modal').classList.add('hidden');
        });

        document.getElementById('integration-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const modal = document.getElementById('integration-modal');
            const type = modal.dataset.type;
            const form = e.target;
            const formData = new FormData(form);

            const fieldDefs = INTEGRATION_FIELDS[type] || [];
            const config = { type };
            fieldDefs.forEach(field => {
                if (field.type === 'checkbox') {
                    config[field.name] = formData.has(field.name);
                } else {
                    const value = formData.get(field.name);
                    if (value) config[field.name] = value;
                }
            });

            try {
                await api(`/integrations/${type}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        config: config,
                        enabled: formData.has('enabled'),
                    }),
                });
                modal.classList.add('hidden');
                loadIntegrations();
            } catch (err) {
                alert('Failed to save integration');
            }
        });

        document.getElementById('modal-test').addEventListener('click', async () => {
            const modal = document.getElementById('integration-modal');
            const type = modal.dataset.type;
            const form = document.getElementById('integration-form');
            const formData = new FormData(form);
            const testBtn = document.getElementById('modal-test');

            // Build config from current form values
            const fieldDefs = INTEGRATION_FIELDS[type] || [];
            const config = { type };
            fieldDefs.forEach(field => {
                if (field.type === 'checkbox') {
                    config[field.name] = formData.has(field.name);
                } else {
                    const value = formData.get(field.name);
                    if (value) config[field.name] = value;
                }
            });

            // Show loading state
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '<span class="btn-spinner"></span>Testing...';
            testBtn.disabled = true;

            try {
                const result = await api(`/integrations/${type}/test`, {
                    method: 'POST',
                    body: JSON.stringify({ config }),
                });
                alert(result.success ? result.message : `Test failed: ${result.message}`);
            } catch {
                alert('Connection test failed');
            } finally {
                // Restore button state
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            }
        });

        // LoFi Modal Functions
        let lofiEmail = '';

        function openLofiModal() {
            const modal = document.getElementById('lofi-modal');
            // Check if there's an existing lofi integration
            const existing = integrations.find(i => i.integration_type === 'lofi');

            if (existing && existing.config) {
                // Show appropriate step based on status
                if (existing.config.device_linked) {
                    showLofiStep('active');
                } else {
                    lofiEmail = existing.config.email || '';
                    document.getElementById('lofi-pending-email').textContent = lofiEmail;
                    showLofiStep('pending');
                }
            } else {
                // Fresh setup - prefill callsign from user profile
                document.getElementById('lofi-callsign').value = currentUser.callsign || '';
                document.getElementById('lofi-email').value = currentUser.email || '';
                showLofiStep('setup');
            }

            modal.classList.remove('hidden');
        }

        function closeLofiModal() {
            document.getElementById('lofi-modal').classList.add('hidden');
            document.getElementById('lofi-setup-error').classList.add('hidden');
            document.getElementById('lofi-pending-error').classList.add('hidden');
        }

        function showLofiStep(step) {
            document.getElementById('lofi-step-setup').classList.add('hidden');
            document.getElementById('lofi-step-pending').classList.add('hidden');
            document.getElementById('lofi-step-active').classList.add('hidden');
            document.getElementById(`lofi-step-${step}`).classList.remove('hidden');
        }

        // LoFi Setup button
        document.getElementById('lofi-setup-btn').addEventListener('click', async () => {
            const callsign = document.getElementById('lofi-callsign').value.trim().toUpperCase();
            const email = document.getElementById('lofi-email').value.trim();
            const errorEl = document.getElementById('lofi-setup-error');

            if (!callsign || !email) {
                errorEl.textContent = 'Callsign and email are required';
                errorEl.classList.remove('hidden');
                return;
            }

            errorEl.classList.add('hidden');
            const btn = document.getElementById('lofi-setup-btn');
            btn.disabled = true;
            btn.textContent = 'Setting up...';

            try {
                const result = await api('/integrations/lofi/setup', {
                    method: 'POST',
                    body: JSON.stringify({ callsign, email }),
                });

                if (result.success) {
                    lofiEmail = email;
                    document.getElementById('lofi-pending-email').textContent = email;
                    showLofiStep('pending');
                    loadIntegrations();
                } else {
                    errorEl.textContent = result.message || 'Setup failed';
                    errorEl.classList.remove('hidden');
                }
            } catch (e) {
                errorEl.textContent = 'Setup failed: ' + e.message;
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Setup LoFi';
            }
        });

        // LoFi Cancel buttons
        document.getElementById('lofi-cancel-btn').addEventListener('click', closeLofiModal);
        document.getElementById('lofi-pending-cancel-btn').addEventListener('click', closeLofiModal);
        document.getElementById('lofi-done-btn').addEventListener('click', closeLofiModal);

        // LoFi Confirm button
        document.getElementById('lofi-confirm-btn').addEventListener('click', async () => {
            const errorEl = document.getElementById('lofi-pending-error');
            const btn = document.getElementById('lofi-confirm-btn');
            btn.disabled = true;
            btn.textContent = 'Confirming...';

            try {
                const result = await api('/integrations/lofi/confirm', { method: 'POST' });

                if (result.success) {
                    showLofiStep('active');
                    loadIntegrations();
                } else {
                    errorEl.textContent = result.message || 'Confirmation failed';
                    errorEl.classList.remove('hidden');
                }
            } catch (e) {
                errorEl.textContent = 'Confirmation failed: ' + e.message;
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = "I've Confirmed";
            }
        });

        // LoFi Resend button
        document.getElementById('lofi-resend-btn').addEventListener('click', async () => {
            const email = prompt('Enter email address:', lofiEmail);
            if (!email) return;

            const btn = document.getElementById('lofi-resend-btn');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const result = await api('/integrations/lofi/send-link', {
                    method: 'POST',
                    body: JSON.stringify({ email }),
                });

                if (result.success) {
                    lofiEmail = email;
                    document.getElementById('lofi-pending-email').textContent = email;
                    alert('Confirmation email sent!');
                } else {
                    alert(result.message || 'Failed to send email');
                }
            } catch (e) {
                alert('Failed to send email: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Resend Email';
            }
        });

        // LoFi Remove button
        document.getElementById('lofi-remove-btn').addEventListener('click', async () => {
            if (!confirm('Remove LoFi integration?')) return;
            await deleteIntegration('lofi');
            closeLofiModal();
        });

        // POTA checkbox event delegation
        document.getElementById('pota-valid-activations').addEventListener('change', (e) => {
            if (e.target.classList.contains('pota-activation-checkbox')) {
                updatePotaUploadButton();
            }
        });

        // File Upload
        document.getElementById('upload-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('adif-file');
            const status = document.getElementById('upload-status');

            if (!fileInput.files.length) {
                status.textContent = 'Please select a file';
                status.className = 'status error';
                status.classList.remove('hidden');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            status.textContent = 'Uploading...';
            status.className = 'status';
            status.classList.remove('hidden');

            try {
                const res = await fetch('/api/logs/upload', {
                    method: 'POST',
                    body: formData,
                });
                const result = await res.json();

                if (result.success) {
                    status.textContent = result.message || 'Upload successful!';
                    status.className = 'status success';
                    fileInput.value = '';
                    loadQsoStats();
                } else {
                    status.textContent = result.message || 'Upload failed';
                    status.className = 'status error';
                }
            } catch (err) {
                status.textContent = 'Upload failed: ' + err.message;
                status.className = 'status error';
            }
        });

        // QSO Stats
        async function loadQsoStats() {
            const loadingEl = document.getElementById('qsos-loading');
            const contentEl = document.getElementById('qsos-content');

            loadingEl.classList.remove('hidden');
            contentEl.classList.add('hidden');

            try {
                const stats = await api('/qsos/stats');
                document.getElementById('qso-stats').innerHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${stats.total_qsos || 0}</div>
                        <div class="stat-label">Total QSOs</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.synced_qrz || 0}</div>
                        <div class="stat-label">Synced to QRZ</div>
                    </div>
                    <div class="stat-item" style="opacity: 0.6;">
                        <div class="stat-value">--</div>
                        <div class="stat-label">LotW Confirmed <span class="badge under-construction" style="font-size: 0.6rem;">Coming Soon</span></div>
                    </div>
                `;
                // Also load recent QSOs
                await loadRecentQsos();
            } catch (err) {
                console.error('Failed to load QSO stats:', err);
                document.getElementById('qso-stats').innerHTML = `
                    <div class="stat-item" style="grid-column: 1 / -1;">
                        <div class="stat-label">Failed to load statistics</div>
                    </div>
                `;
            } finally {
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
            }
        }

        async function loadRecentQsos() {
            try {
                const qsos = await api('/qsos/recent');
                const tbody = document.querySelector('#qso-table tbody');
                if (qsos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-dim);">No QSOs found</td></tr>';
                    return;
                }
                tbody.innerHTML = qsos.map(q => {
                    const date = q.qso_date.length === 8
                        ? `${q.qso_date.slice(0,4)}-${q.qso_date.slice(4,6)}-${q.qso_date.slice(6,8)}`
                        : q.qso_date;
                    const time = q.time_on.length >= 4
                        ? `${q.time_on.slice(0,2)}:${q.time_on.slice(2,4)}`
                        : q.time_on;
                    const syncStatus = q.qrz_synced
                        ? '<span style="color: var(--badge-enabled-text);">Synced</span>'
                        : '<span style="color: var(--text-dim);">Pending</span>';
                    return `<tr>
                        <td>${date} ${time}</td>
                        <td><strong>${q.call}</strong></td>
                        <td>${q.band}</td>
                        <td>${q.mode}</td>
                        <td>${syncStatus}</td>
                    </tr>`;
                }).join('');
            } catch (err) {
                console.error('Failed to load recent QSOs:', err);
                const tbody = document.querySelector('#qso-table tbody');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-dim);">Failed to load QSOs</td></tr>';
            }
        }

        // Profile form
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            try {
                await api('/users/me', {
                    method: 'PUT',
                    body: JSON.stringify({
                        callsign: form.callsign.value || null,
                        email: form.email.value || null,
                    }),
                });
                alert('Profile updated');
                checkAuth();
            } catch {
                alert('Failed to update profile');
            }
        });

        // Theme selector
        document.getElementById('theme-select').addEventListener('change', async (e) => {
            const theme = e.target.value;
            applyTheme(theme);
            try {
                await api('/users/me/theme', {
                    method: 'PUT',
                    body: JSON.stringify({ theme }),
                });
                currentUser.theme = theme;
            } catch {
                // Revert on error
                applyTheme(currentUser.theme || 'light');
                e.target.value = currentUser.theme || 'light';
                alert('Failed to save theme preference');
            }
        });

        // Password form
        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;

            if (form.new_password.value !== form.confirm_password.value) {
                alert('Passwords do not match');
                return;
            }

            try {
                const result = await api('/users/me/password', {
                    method: 'PUT',
                    body: JSON.stringify({
                        current_password: form.current_password.value,
                        new_password: form.new_password.value,
                    }),
                });
                if (result.success) {
                    alert('Password changed successfully');
                    form.reset();
                } else {
                    alert(result.message || 'Failed to change password');
                }
            } catch {
                alert('Failed to change password');
            }
        });

        // Init
        // Populate dropdown options immediately (before login)
        function populateIntegrationDropdown() {
            const dropdownOptions = document.getElementById('add-integration-options');
            const allTypes = Object.keys(INTEGRATION_TYPES);
            dropdownOptions.innerHTML = allTypes.map(type => {
                const meta = INTEGRATION_TYPES[type];
                return `
                    <div class="dropdown-item" onclick="addIntegration('${type}')">
                        <strong>${meta.name}</strong>
                        <div class="desc">${meta.desc}</div>
                    </div>
                `;
            }).join('');
        }
        populateIntegrationDropdown();
        checkAuth();
    </script>
</body>
</html>
